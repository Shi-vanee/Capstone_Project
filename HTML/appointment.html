<?php include('session_handler.php'); ?>

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Book Appointment</title>
  <link rel="stylesheet" href="css/bootstrap.css">
  <link rel="stylesheet" href="css/appointment_style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.3.0/css/datepicker.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/css/intlTelInput.css">
  <style>
    /* Your existing styles here */
    .form-group.hidden {
      display: none;
    }
  </style>
</head>

<body>
  <!-- Header Section -->
  <header class="header_section">
    <div class="container">
      <h1>Book an Appointment</h1>
      <p>Fill out the form below to book your appointment with the selected doctor.</p>
    </div>
  </header>

  <!-- Appointment Form -->
  <div class="container">
    <?php if (isset($_GET['success']) && $_GET['success'] == '1'): ?>
      <!-- Success notification code -->
    <?php endif; ?>

    <form method="POST" action="appointment_confirmation.php">
      <input type="hidden" name="DoctorID" value="1">

      <!-- User Name Information -->
      <div class="form-group">
        <label for="fName">First Name:</label>
        <input type="text" class="form-control" id="fName" name="fName" placeholder="Enter your first name" required>
      </div>

      <div class="form-group">
        <label for="lName">Last Name:</label>
        <input type="text" class="form-control" id="lName" name="lName" placeholder="Enter your last name" required>
      </div>
      
      <!-- Doctor's Information -->
      <div class="form-group">
        <label for="doctor-name">Doctor's Name:</label>
        <input type="text" class="form-control" id="doctor-name" name="doctor_name" readonly>
      </div>

      <div class="form-group">
        <label for="doctor-specialization">Specialization:</label>
        <input type="text" class="form-control" id="doctor-specialization" name="specialization" readonly>
      </div>

      <!-- Date Picker -->
      <div class="form-group">
        <label for="appointment-date">Select Appointment Date:</label>
        <input type="text" class="form-control datepicker" id="appointment-date" name="appointment_date" required>
      </div>

      <!-- Time Picker -->
      <div class="form-group">
        <label for="appointment-time">Select Appointment Time:</label>
        <input type="time" class="form-control" id="appointment-time" name="appointment_time" required>
      </div>

      <!-- Appointment Type -->
      <div class="form-group" id="appointment-type-group">
        <label for="appointment-type">Appointment Type:</label>
        <select class="form-control" id="appointment-type" name="appointment_type" required>
          <option value="">Select Type</option>
          <option value="online">Online</option>
          <option value="face-to-face">Face-to-Face</option>
        </select>
      </div>

      <!-- Online Platform (Hidden by Default) -->
      <div class="form-group hidden" id="online-platform-group">
        <label for="online-platform">Online Platform:</label>
        <input type="text" class="form-control" id="online-platform" name="online_platform" readonly>
      </div>

      <!-- Clinic Address (Hidden by Default) -->
      <div class="form-group hidden" id="clinic-address-group">
        <label for="clinic-address">Clinic Address:</label>
        <input type="text" class="form-control" id="clinic-address" name="clinic_address" readonly>
      </div>

      <!-- Rest of your form fields -->
      <div class="form-group">
        <label for="email">Email Address:</label>
        <input type="email" class="form-control" id="email" name="email" placeholder="Enter your email" required>
      </div>

      <div class="form-group">
        <label for="phone-number">Phone Number:</label>
        <input type="tel" class="form-control" id="phone-number" name="phone_number" placeholder="Enter your phone number" required>
      </div>

      <div class="form-group">
        <label for="country">Select Country:</label>
        <select class="form-control" id="country" name="country" required>
          <option value="">Select Your Country</option>
          <option value="Mauritius">Mauritius</option>
          <option value="United States">United States</option>
          <option value="India">India</option>
          <option value="United Kingdom">United Kingdom</option>
          <option value="France">France</option>
        </select>
      </div>

      <div class="form-group">
        <label for="address">Address (if applicable):</label>
        <input type="text" class="form-control" id="address" name="address" placeholder="Enter your exact address">
      </div>

      <button type="submit" class="btn btn-primary">Book Appointment</button>
    </form>

    <button onclick="window.location.href='dashboard.php'" class="btn btn-secondary mt-3">Back to Dashboard</button>
  </div>

  <footer class="footer_section">
    <div class="container">
      <p>&copy; <span id="displayYear"></span> All Rights Reserved By Trust MediCare</p>
    </div>
  </footer>

  <!-- Scripts -->
  <script src="js/jquery-3.4.1.min.js"></script>
  <script src="js/bootstrap.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.3.0/js/bootstrap-datepicker.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/js/intlTelInput.min.js"></script>

  <script>
    $(document).ready(function () {
      // Retrieve URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const doctorName = urlParams.get('doctor_name');
      const specialization = urlParams.get('specialization');
      const appointmentType = urlParams.get('appointment_type');
      const platform = urlParams.get('platform');
      const clinicAddress = urlParams.get('clinic_address');

      // Set doctor info
      $('#doctor-name').val(doctorName);
      $('#doctor-specialization').val(specialization);

      // Auto-set appointment type and related fields
      if (appointmentType) {
        $('#appointment-type').val(appointmentType);
        
        if (appointmentType === 'online') {
          $('#online-platform-group').removeClass('hidden');
          $('#online-platform').val(platform);
        } 
        else if (appointmentType === 'face-to-face') {
          $('#clinic-address-group').removeClass('hidden');
          $('#clinic-address').val(clinicAddress);
        }
        
        // Disable the appointment type selection
        $('#appointment-type').prop('disabled', true);
      }

      // Handle appointment type change
      $('#appointment-type').change(function() {
        const selectedType = $(this).val();
        
        // Hide all optional fields first
        $('#online-platform-group').addClass('hidden');
        $('#clinic-address-group').addClass('hidden');
        
        // Show relevant field
        if (selectedType === 'online') {
          $('#online-platform-group').removeClass('hidden');
        } 
        else if (selectedType === 'face-to-face') {
          $('#clinic-address-group').removeClass('hidden');
        }
      });

      // Initialize datepicker and other plugins
      $('#appointment-date').datepicker({
        format: 'yyyy-mm-dd',
        daysOfWeekDisabled: [0, 6]
      });

      // Initialize phone input
      const phoneInput = document.querySelector("#phone-number");
      const iti = intlTelInput(phoneInput, {
        initialCountry: "auto",
        geoIpLookup: function (callback) {
          fetch('https://ipapi.co/json/')
            .then(response => response.json())
            .then(data => callback(data.country_code))
            .catch(() => callback('US'));
        },
        utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/js/utils.js",
      });

      // Set current year in footer
      document.getElementById("displayYear").textContent = new Date().getFullYear();
    });
  </script>
</body>
</html>